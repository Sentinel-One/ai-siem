{
    "pipeline": {
        "id": "0",
        "siteId": "16",
        "name": "Pipeline Template_Netskope_alerts",
        "description": "",
        "status": "DEFAULT",
        "createdAt": "2025-11-19T20:31:49.639779Z",
        "updatedAt": "2025-11-20T21:18:17.522242Z",
        "deletedAt": null,
        "createdBy": "",
        "updatedBy": "",
        "deployedGraphVersion": 0,
        "pendingGraphVersion": 0,
        "latestGraphVersion": 0,
        "sourceId": "0",
        "pipelineType": "PIPELINE_TYPE_USER",
        "pendingAction": "NOP",
        "analytics": []
    },
    "pipelineGraph": {
        "version": 4,
        "pipelineId": "0",
        "edges": {
            "100000000000000029": {
                "nodeIds": [
                    "300000000000000233"
                ]
            },
            "300000000000000233": {
                "nodeIds": [
                    "200000000000000044"
                ]
            }
        },
        "created": "2025-11-20T21:18:17.522242Z",
        "createdBy": "",
        "metaInfo": {
            "omissions": [
                {
                    "omitted": {
                        "100000000000000029": {
                            "nodeIds": [
                                "300000000000000344"
                            ]
                        },
                        "300000000000000344": {
                            "nodeIds": [
                                "300000000000000233"
                            ]
                        }
                    },
                    "patch": {
                        "100000000000000029": {
                            "nodeIds": [
                                "300000000000000233"
                            ]
                        }
                    }
                },
                {
                    "omitted": {
                        "300000000000000207": {
                            "nodeIds": [
                                "200000000000000044"
                            ]
                        },
                        "300000000000000233": {
                            "nodeIds": [
                                "300000000000000207"
                            ]
                        }
                    },
                    "patch": {
                        "300000000000000233": {
                            "nodeIds": [
                                "200000000000000044"
                            ]
                        }
                    }
                }
            ]
        }
    },
    "source": {
        "id": "100000000000000029",
        "siteId": "16",
        "templateId": "28",
        "templateVersion": "1",
        "templateName": "Netskope Alerts",
        "name": "Source Netskope test",
        "description": "",
        "config": {
            "auth.header": "Netskope-api-token",
            "auth.strategy": "bearer",
            "auth.token": "cmJhY3YzOkJrWWNGdG93cVNpSUhGbXI0c3BMNw==",
            "config": {
                "ALERT_TYPES": "dlp,policy",
                "NETSKOPE_URL": "https://partner-sentinelone.goskope.com/api/v2/events/data/alert",
                "QUERY_TIME_RANGE_INTERVAL_IN_SECS": "300"
            },
            "overrides": [],
            "retry.backoff_scaling_factor": 2,
            "retry.initial_backoff_secs": 1,
            "retry.max_backoff_secs": 5,
            "retry.max_retries": 4,
            "scale.completion_queue": 10,
            "scale.event_batch_queue": 10,
            "scale.fetch_req_queue": 1000,
            "scale.fetch_res_queue": 10,
            "scale.fetchers": 8,
            "scale.runtimes": 2,
            "script": "function start(config)\n    -- get START_TIME checkpoint value\n    local start_time = get_chkpt(\"START_TIME_UNIX_TIMESTAMP\")\n    \n    -- convert string to number\n    local start_time_int = tonumber(start_time)\n    \n    -- get time range in secs\n    local time_range_interval_in_secs = tonumber(config[\"QUERY_TIME_RANGE_INTERVAL_IN_SECS\"])\n    \n    -- compute end time\n    local end_time_int = start_time_int + time_range_interval_in_secs\n    \n    \n    local alert_types_string = config[\"ALERT_TYPES\"]\n    local alert_types = {}\n    \n    -- convert comma seperated string to a table\n    for alert_type in string.gmatch(alert_types_string, \"([^,]+)\") do\n        table.insert(alert_types, alert_type:match(\"^%s*(.-)%s*$\"))  -- trim whitespace\n    end\n    \n    -- for each alert_type make a fetch call\n    for i, alert_type in ipairs(alert_types) do  \n        fetch {\n            params = {\n                url = config[\"NETSKOPE_URL\"],\n                query = {starttime = start_time_int, endtime = end_time_int, type = alert_type},\n                method = \"GET\",\n                headers = {\n                  [\"Accept\"] = \"application/json\"\n                }\n            },\n            fn = \"data\",\n            retry = false,\n            context = {alert_type = alert_type}\n        }\n    end\nend\n\n\nlocal json = require('json')\nlocal logger = require('log')\nfunction data(config, response, context)\n    if response.status == 200 then\n        local results = {}\n        local body_bytes = response.body\n        local body = json.decode(body_bytes)\n        \n        local timestamps = {}\n        \n        for i, e in ipairs(body[\"result\"]) do\n            \n            -- store timestamp values in table\n            table.insert(timestamps, e[\"timestamp\"])\n            \n            -- emit each result\n            emit{log = e}\n        end\n        \n        -- Sort timestamps in ascending order\n        table.sort(timestamps)\n        \n        -- Get the highest timestamp (last element after sorting)\n        local highest_timestamp = timestamps[#timestamps]\n        set_chkpt(\"START_TIME_UNIX_TIMESTAMP\",tostring(highest_timestamp))\n    else\n        local err_msg = \"URL: \" .. config[\"NETSKOPE_URL\"] .. \", Status Code: \" .. tostring(response.status) .. \", Alert Type: \" .. tostring(context.alert_type)\n        logger.error(\"Error occurred while making the fetch call. \" .. err_msg)\n\n    end\nend",
            "seed_checkpoints": {
                "START_TIME_UNIX_TIMESTAMP": "1760994874"
            },
            "start_routine": "start",
            "tls.enabled": false,
            "trigger.interval_secs": 60
        },
        "status": "NS_ACTIVE",
        "created": "2025-11-20T21:17:36.825058Z",
        "updated": "2025-11-20T21:21:38.351945Z",
        "createdBy": "",
        "updatedBy": "",
        "type": "SCOL",
        "origin": "NODE_ORIGIN_USER",
        "archivalInfo": null,
        "logFormat": "LOG_FORMAT_UNSPECIFIED",
        "preprocessorConfig": null,
        "port": 0,
        "pushBased": false,
        "pushSourceAddress": "",
        "k8sInternalSvcUrl": "",
        "siteFilenames": [],
        "sourceConfigs": [
            {
                "id": "0",
                "sourceId": "0",
                "templateId": "65",
                "templateName": "PatternExtractorPostProcessor",
                "category": "PATTERN_EXTRACTOR",
                "config": {
                    "config_groups": [
                        {
                            "_name": "Pattern Extractor Configs",
                            "clusterTagNames": [],
                            "truncate": false
                        }
                    ]
                },
                "position": 0,
                "templateVersion": "1"
            },
            {
                "id": "0",
                "sourceId": "0",
                "templateId": "46",
                "templateName": "SentimentAnalyzer",
                "category": "PATTERN_EXTRACTOR",
                "config": {
                    "config_groups": [
                        {
                            "_name": "Config",
                            "enabled": false,
                            "keyNameForExtractedSentiment": "sentiment",
                            "logLocations": [],
                            "negativeSentimentRegexes": [
                                "time[\\s_-]*out",
                                "timed[\\s_-]*out",
                                "(?i)alert ([=\\s\\*]+|$)",
                                "(?i)bad[\\s_-]*gateway",
                                "(?i)bad[\\s_-]*request",
                                "(?i)(^| [=\\s\\*]+)bad([=\\s\\*]+|$)",
                                "(?i)does[\\s_-]*not[\\s_-]*exist",
                                "(?i)[=\\s\\*]+eof([=\\s\\*]+|$)",
                                "(?i)exception([=\\s\\*]+|$)",
                                "(?i)fail([=\\s\\*]+|$)",
                                "(?i)failed([=\\s\\*]+|$)",
                                "(?i)failure([=\\s\\*]+|$)",
                                "(?i)(^|[=\\s\\*]+)fault([=\\s\\*]+|$)",
                                "(?i)(^| [=\\s\\*]+)feof([=\\s\\*]+|$)",
                                "(?i)not[\\s_-]*acceptable",
                                "(?i)not[\\s_-]*allowed",
                                "(?i)not[\\s_-]*found",
                                "(?i)not[\\s_-]*ok",
                                "(?i)(^| [=\\s\\*]+)oom([=\\s\\*]+|$)",
                                "(?i)too[\\s_-]*many"
                            ],
                            "negativeSentimentWords": [
                                "abnormal",
                                "abort",
                                "broken",
                                "canceled",
                                "caught",
                                "critical",
                                "denied",
                                "emergency",
                                "error",
                                "exception",
                                "fatal",
                                "incomplete",
                                "insufficient",
                                "interrupt",
                                "killed",
                                "killing",
                                "malformed",
                                "mismatch",
                                "outofmemory",
                                "panic",
                                "segfault",
                                "terminate",
                                "timeout",
                                "unable",
                                "unauthorized",
                                "undefined",
                                "unexpected",
                                "unprocessable",
                                "unstable",
                                "unhandled",
                                "unsuccessful",
                                "unusable",
                                "violation",
                                "rejection",
                                "rejected"
                            ],
                            "useLogPath": true
                        }
                    ]
                },
                "position": 1,
                "templateVersion": "1"
            },
            {
                "id": "0",
                "sourceId": "0",
                "templateId": "71",
                "templateName": "GeneratorVersion",
                "category": "INTERNAL",
                "config": {
                    "generator_version": "v2"
                },
                "position": 0,
                "templateVersion": "0"
            }
        ],
        "userVisible": true,
        "usageType": "USER"
    },
    "destinations": [
        {
            "id": "200000000000000044",
            "siteId": "16",
            "templateId": "25",
            "templateVersion": "0",
            "templateName": "SentinelOne AI SIEM",
            "name": "Sink Template_SentinelOne AI SIEM",
            "description": "This is the Default approach to Send data into your SentinelOne Console",
            "config": {
                "acknowledgements.enabled": false,
                "acknowledgements.indexer_acknowledgements_enabled": true,
                "acknowledgements.query_interval": 10,
                "acknowledgements.retry_limit": 30,
                "batch.timeout_secs": 1,
                "compression": "none",
                "default_token": "********",
                "encoding.codec": "json",
                "encoding.json.pretty": false,
                "encoding.metric_tag_values": "single",
                "endpoint": "https://ingest.us1.sentinelone.net",
                "endpoint_target": "event",
                "host_key": "host",
                "path": "/services/collector/event?isParsed=true",
                "request.concurrency": "adaptive",
                "request.headers": {},
                "request.rate_limit_duration_secs": 1,
                "request.retry_initial_backoff_secs": 1,
                "request.retry_max_duration_secs": 3600,
                "request.timeout_secs": 60,
                "timestamp_key": "timestamp",
                "tls.verify_certificate": false,
                "tls.verify_hostname": false
            },
            "status": "NS_ACTIVE",
            "sourceId": "0",
            "created": "2025-11-16T22:17:36.683043Z",
            "updated": "2025-11-20T17:19:18.696952Z",
            "createdBy": "",
            "updatedBy": "",
            "type": "SPLUNK_HEC_LOGS",
            "origin": "NODE_ORIGIN_USER",
            "usageType": "USER",
            "siteFilenames": [],
            "userVisible": true
        }
    ],
    "transforms": [
        {
            "id": "300000000000000233",
            "siteId": "16",
            "templateId": "60",
            "templateVersion": "2",
            "name": "Transform Template_Netskope_Log_Collector",
            "description": "",
            "pipelineId": "0",
            "config": {
                "config_groups": [
                    {
                        "_name": "General Configuration",
                        "bypassed": false,
                        "filterEnabled": false
                    },
                    {
                        "_name": "ocsf",
                        "enabled": true,
                        "parallelism": 1,
                        "script": "\n-- Netskope to OCSF Mapping Script\n-- Maps Netskope log events to OCSF v1.5.0 Detection Finding [2004] format\n-- 100% compliant with OCSF schema validation\n--\n-- Usage: processEvent(event) -> ocsf_event\n\n-- Given a list of mappings return a set of first level \n\nlocal FEATURES = {\n    FLATTEN_EVENT_TYPE = true,\n}\n\nfunction mappedFields(fieldMappings)\n  local mapped = {}\n  for _, v in ipairs(fieldMappings) do\n    source = v['source']\n    mapped[source] = true\n  end\n  return mapped\nend\n\n-- Helper to check if a table is an array\nlocal function isArray(t)\n    if type(t) ~= \"table\" then return false end\n    local i = 0\n    for _ in pairs(t) do\n        i = i + 1\n        if t[i] == nil then\n            return false\n        end\n    end\n    return true\nend\n\nfunction copyUnmappedFields(event, fieldMappings, result)\n    -- copy everything else to unmapped\n    flattenEvent = flattenObject(event)\n    mapped = mappedFields(fieldMappings)\n    for k, v in pairs(flattenEvent) do\n        if k ~= \"_ob\" and not mapped[k] and v ~= nil and v ~= \"\" then\n            setNestedField(result, \"unmapped.\" .. k, v)\n        end\n    end\n    return result\nend\n\nfunction flattenObject(tbl, prefix, result)\n    result = result or {}\n    prefix = prefix or \"\"\n    for k, v in pairs(tbl) do\n        local keyPath = prefix ~= \"\" and (prefix .. \".\" .. tostring(k)) or tostring(k)\n        local vtype = type(v)\n        if vtype == \"table\" then\n            if isArray(v) then\n                -- Keep arrays as is\n                result[keyPath] = v\n            else\n                flattenObject(v, keyPath, result)\n            end\n        elseif vtype == \"userdata\" then\n            -- Handle userdata safely\n            local ok, s = pcall(tostring, v)\n            if not ok then\n                result[keyPath] = nil\n            end\n            if s == \"userdata: (nil)\" then\n                result[keyPath] = nil\n            end\n            if s == \"userdata: 0x0\" then\n                result[keyPath] = nil\n            end\n        else\n            result[keyPath] = v\n        end\n    end\n    return result\nend\n\nlocal POLICY_FIELD_ORDERS = {\n    root = {\n        \"_category_id\",\n        \"_category_name\",\n        \"_category_tags\",\n        \"_content_version\",\n        \"_correlation_id\",\n        \"_creation_timestamp\",\n        \"_ef_received_at\",\n        \"_event_id\",\n        \"_forwarded_by\",\n        \"_gef_src_dp\",\n        \"_id\",\n        \"_insertion_epoch_timestamp\",\n        \"_nshostname\",\n        \"_nsp_dur_back\",\n        \"_nsp_dur_front\",\n        \"_nsp_retrans_back\",\n        \"_nsp_retrans_front\",\n        \"_nsp_rtt_back\",\n        \"_nsp_rtt_front\",\n        \"_raw_event_inserted_at\",\n        \"_resource_name\",\n        \"_service_identifier\",\n        \"_session_begin\",\n        \"_skip_geoip_lookup\",\n        \"_src_epoch_now\",\n        \"access_method\",\n        \"acked\",\n        \"action\",\n        \"activity\",\n        \"alert\",\n        \"alert_name\",\n        \"alert_type\",\n        \"app\",\n        \"app_session_id\",\n        \"appcategory\",\n        \"browser\",\n        \"browser_session_id\",\n        \"browser_version\",\n        \"category\",\n        \"cci\",\n        \"ccl\",\n        \"connection_id\",\n        \"count\",\n        \"device\",\n        \"device_classification\",\n        \"domain\",\n        \"dst_country\",\n        \"dst_latitude\",\n        \"dst_location\",\n        \"dst_longitude\",\n        \"dst_region\",\n        \"dst_timezone\",\n        \"dst_zipcode\",\n        \"dstip\",\n        \"file_size\",\n        \"file_type\",\n        \"hostname\",\n        \"incident_id\",\n        \"ja3\",\n        \"ja3s\",\n        \"managed_app\",\n        \"managementID\",\n        \"md5\",\n        \"netskope_pop\",\n        \"nsdeviceuid\",\n        \"object\",\n        \"object_type\",\n        \"organization_unit\",\n        \"os\",\n        \"os_version\",\n        \"other_categories\",\n        \"page\",\n        \"page_site\",\n        \"policy\",\n        \"policy_id\",\n        \"port\",\n        \"protocol\",\n        \"request_id\",\n        \"severity\",\n        \"site\",\n        \"src_country\",\n        \"src_latitude\",\n        \"src_location\",\n        \"src_longitude\",\n        \"src_region\",\n        \"src_time\",\n        \"src_timezone\",\n        \"src_zipcode\",\n        \"srcip\",\n        \"telemetry_app\",\n        \"timestamp\",\n        \"title\",\n        \"traffic_type\",\n        \"transaction_id\",\n        \"type\",\n        \"ur_normalized\",\n        \"url\",\n        \"user\",\n        \"useragent\",\n        \"userip\",\n        \"userkey\",\n        \"web_universal_connector\"\n    }\n}\n\nlocal MALWARE_FIELD_ORDERS = {\n    root = {\n        \"_body_size\",\n        \"_category_id\",\n        \"_category_tags\",\n        \"_correlation_id\",\n        \"_detection_name\",\n        \"_ef_received_at\",\n        \"_event_id\",\n        \"_forwarded_by\",\n        \"_gef_src_dp\",\n        \"_home_pop_name\",\n        \"_id\",\n        \"_insertion_epoch_timestamp\",\n        \"_internal_detection_engine\",\n        \"_org_hash\",\n        \"_raw_event_inserted_at\",\n        \"_resource_name\",\n        \"_service_identifier\",\n        \"_src_epoch_now\",\n        \"access_method\",\n        \"acked\",\n        \"action\",\n        \"activity\",\n        \"alert\",\n        \"alert_name\",\n        \"alert_type\",\n        \"app\",\n        \"app_name\",\n        \"app_session_id\",\n        \"appcategory\",\n        \"browser\",\n        \"browser_session_id\",\n        \"browser_version\",\n        \"category\",\n        \"cci\",\n        \"ccl\",\n        \"connection_id\",\n        \"count\",\n        \"detection_engine\",\n        \"device\",\n        \"device_classification\",\n        \"dst_country\",\n        \"dst_geoip_src\",\n        \"dst_latitude\",\n        \"dst_location\",\n        \"dst_longitude\",\n        \"dst_region\",\n        \"dst_timezone\",\n        \"dst_zipcode\",\n        \"dstip\",\n        \"file_category\",\n        \"file_id\",\n        \"file_name\",\n        \"file_size\",\n        \"file_type\",\n        \"hostname\",\n        \"incident_id\",\n        \"instance\",\n        \"instance_id\",\n        \"local_md5\",\n        \"local_sha256\",\n        \"malware_id\",\n        \"malware_name\",\n        \"malware_profile\",\n        \"malware_severity\",\n        \"malware_type\",\n        \"managed_app\",\n        \"managementID\",\n        \"md5\",\n        \"ml_detection\",\n        \"nsdeviceuid\",\n        \"object\",\n        \"object_type\",\n        \"organization_unit\",\n        \"os\",\n        \"os_version\",\n        \"other_categories\",\n        \"page\",\n        \"page_site\",\n        \"policy\",\n        \"policy_id\",\n        \"protocol\",\n        \"request_id\",\n        \"sanctioned_instance\",\n        \"scanner_result\",\n        \"severity\",\n        \"severity_id\",\n        \"site\",\n        \"src_country\",\n        \"src_geoip_src\",\n        \"src_latitude\",\n        \"src_location\",\n        \"src_longitude\",\n        \"src_region\",\n        \"src_time\",\n        \"src_timezone\",\n        \"src_zipcode\",\n        \"srcip\",\n        \"timestamp\",\n        \"title\",\n        \"traffic_type\",\n        \"transaction_id\",\n        \"true_filetype\",\n        \"tss_mode\",\n        \"type\",\n        \"ur_normalized\",\n        \"url\",\n        \"user\",\n        \"user_id\",\n        \"userip\",\n        \"userkey\"\n    }\n}\n\nlocal SECURITY_ASSESSMENT_FIELD_ORDERS = {\n    root = {\n        \"_category_id\",\n        \"_correlation_id\",\n        \"_ef_received_at\",\n        \"_event_id\",\n        \"_forwarded_by\",\n        \"_gef_src_dp\",\n        \"_id\",\n        \"_insertion_epoch_timestamp\",\n        \"_raw_event_inserted_at\",\n        \"_service_identifier\",\n        \"_session_begin\",\n        \"access_method\",\n        \"account_id\",\n        \"account_name\",\n        \"acked\",\n        \"action\",\n        \"activity\",\n        \"alert\",\n        \"alert_name\",\n        \"alert_type\",\n        \"app\",\n        \"appcategory\",\n        \"asset_id\",\n        \"asset_object_id\",\n        \"browser\",\n        \"category\",\n        \"cci\",\n        \"ccl\",\n        \"compliance_standards\",\n        \"count\",\n        \"device\",\n        \"iaas_asset_tags\",\n        \"iaas_remediated\",\n        \"instance_id\",\n        \"object\",\n        \"object_type\",\n        \"organization_unit\",\n        \"os\",\n        \"other_categories\",\n        \"policy\",\n        \"policy_id\",\n        \"region_id\",\n        \"region_name\",\n        \"resource_category\",\n        \"resource_group\",\n        \"sa_profile_id\",\n        \"sa_profile_name\",\n        \"sa_rule_id\",\n        \"sa_rule_name\",\n        \"sa_rule_severity\",\n        \"site\",\n        \"timestamp\",\n        \"traffic_type\",\n        \"type\",\n        \"ur_normalized\",\n        \"user\",\n        \"userkey\"\n    },\n    compliance_standards = {\n        \"control\",\n        \"description\",\n        \"id\",\n        \"reference_url\",\n        \"section\",\n        \"standard\"\n    },\n    iaas_asset_tags = {\n        \"name\",\n        \"value\"\n    }\n}\n\nlocal MALSITE_FIELD_ORDERS = {\n    root = {\n        \"_appsession_start\",\n        \"_category_id\",\n        \"_category_tags\",\n        \"_correlation_id\",\n        \"_creation_timestamp\",\n        \"_ef_received_at\",\n        \"_event_id\",\n        \"_forwarded_by\",\n        \"_gef_src_dp\",\n        \"_id\",\n        \"_insertion_epoch_timestamp\",\n        \"_nshostname\",\n        \"_policy_category_id\",\n        \"_raw_event_inserted_at\",\n        \"_service_identifier\",\n        \"_skip_geoip_lookup\",\n        \"_src_epoch_now\",\n        \"access_method\",\n        \"acked\",\n        \"action\",\n        \"alert\",\n        \"alert_name\",\n        \"alert_type\",\n        \"app\",\n        \"app_session_id\",\n        \"appcategory\",\n        \"browser\",\n        \"browser_session_id\",\n        \"browser_version\",\n        \"category\",\n        \"cci\",\n        \"ccl\",\n        \"connection_id\",\n        \"count\",\n        \"device\",\n        \"device_classification\",\n        \"domain\",\n        \"dst_country\",\n        \"dst_latitude\",\n        \"dst_location\",\n        \"dst_longitude\",\n        \"dst_region\",\n        \"dst_timezone\",\n        \"dst_zipcode\",\n        \"dstip\",\n        \"hostname\",\n        \"incident_id\",\n        \"ja3\",\n        \"ja3s\",\n        \"malicious\",\n        \"malsite_category\",\n        \"malsite_country\",\n        \"malsite_id\",\n        \"malsite_ip_host\",\n        \"malsite_latitude\",\n        \"malsite_longitude\",\n        \"malsite_region\",\n        \"managed_app\",\n        \"netskope_pop\",\n        \"organization_unit\",\n        \"os\",\n        \"os_version\",\n        \"other_categories\",\n        \"page\",\n        \"page_site\",\n        \"policy\",\n        \"policy_id\",\n        \"port\",\n        \"protocol\",\n        \"referer\",\n        \"request_id\",\n        \"severity\",\n        \"severity_level\",\n        \"severity_level_id\",\n        \"site\",\n        \"src_country\",\n        \"src_latitude\",\n        \"src_location\",\n        \"src_longitude\",\n        \"src_region\",\n        \"src_time\",\n        \"src_timezone\",\n        \"src_zipcode\",\n        \"srcip\",\n        \"telemetry_app\",\n        \"threat_match_field\",\n        \"threat_match_value\",\n        \"threat_source_id\",\n        \"timestamp\",\n        \"traffic_type\",\n        \"transaction_id\",\n        \"type\",\n        \"ur_normalized\",\n        \"url\",\n        \"user\",\n        \"userip\",\n        \"userkey\"\n    }\n}\n\nlocal DLP_FIELD_ORDERS = {\n    root = {\n        \"__cookie_uid\", \n        \"_category_id\", \n        \"_category_tags\", \n        \"_client_file_type\", \n        \"_correlation_id\", \n        \"_ef_received_at\", \n        \"_event_id\", \n        \"_forwarded_by\", \n        \"_gef_src_dp\", \n        \"_id\", \n        \"_insertion_epoch_timestamp\", \n        \"_nshostname\", \n        \"_raw_event_inserted_at\", \n        \"_resource_name\", \n        \"_service_identifier\", \n        \"_skip_geoip_lookup\", \n        \"_src_epoch_now\", \n        \"access_method\", \n        \"acked\", \n        \"action\", \n        \"activity\", \n        \"alert\", \n        \"alert_name\", \n        \"alert_type\", \n        \"app\", \n        \"app_session_id\", \n        \"appcategory\", \n        \"appsuite\", \n        \"browser\", \n        \"browser_session_id\", \n        \"browser_version\", \n        \"category\", \n        \"cci\", \n        \"ccl\", \n        \"connection_id\", \n        \"count\", \n        \"device\", \n        \"device_classification\", \n        \"dlp_file\", \n        \"dlp_incident_id\", \n        \"dlp_is_unique_count\", \n        \"dlp_parent_id\", \n        \"dlp_profile\", \n        \"dlp_rule\", \n        \"dlp_rule_count\", \n        \"dlp_rule_severity\", \n        \"dst_country\", \n        \"dst_geoip_src\",\n        \"dst_latitude\", \n        \"dst_location\", \n        \"dst_longitude\", \n        \"dst_region\", \n        \"dst_timezone\", \n        \"dst_zipcode\", \n        \"dstip\", \n        \"file_lang\", \n        \"file_size\", \n        \"file_type\", \n        \"from_user\", \n        \"hostname\", \n        \"incident_id\", \n        \"instance_id\", \n        \"local_sha256\", \n        \"managed_app\", \n        \"managementID\", \n        \"md5\", \n        \"netskope_pop\", \n        \"nsdeviceuid\", \n        \"object\", \n        \"object_id\", \n        \"object_type\", \n        \"organization_unit\", \n        \"os\",\n        \"os_version\", \n        \"other_categories\",\n        \"page\",\n        \"page_site\", \n        \"policy\", \n        \"policy_id\", \n        \"protocol\", \"referer\", \"request_id\", \"sanctioned_instance\", \"severity\", \"site\", \n        \"src_country\", \"src_geoip_src\", \"src_latitude\", \"src_location\", \"src_longitude\", \n        \"src_region\", \"src_time\", \"src_timezone\", \"src_zipcode\", \"srcip\", \"suppression_key\", \n        \"timestamp\", \"traffic_type\", \"transaction_id\", \"true_obj_category\", \"true_obj_type\", \"tss_mode\",\n        \"type\", \"ur_normalized\", \"url\", \"user\", \"userip\", \"userkey\"\n    }\n}\n\nlocal UBA_FIELD_ORDERS = {\n    root = {\n        \"_category_id\",\n        \"_category_tags\",\n        \"_correlation_id\",\n        \"_ef_received_at\",\n        \"_event_id\",\n        \"_forwarded_by\",\n        \"_gef_src_dp\",\n        \"_id\",\n        \"_insertion_epoch_timestamp\",\n        \"_raw_event_inserted_at\",\n        \"_service_identifier\",\n        \"_session_begin\",\n        \"access_method\",\n        \"acked\",\n        \"action\",\n        \"activity\",\n        \"alert\",\n        \"alert_id\",\n        \"alert_name\",\n        \"alert_type\",\n        \"app\",\n        \"app_session_id\",\n        \"appcategory\",\n        \"browser\",\n        \"browser_session_id\",\n        \"browser_version\",\n        \"category\",\n        \"ccl\",\n        \"connection_id\",\n        \"count\",\n        \"device\",\n        \"download_app\",\n        \"dst_country\",\n        \"dst_geoip_src\",\n        \"dst_latitude\",\n        \"dst_location\",\n        \"dst_longitude\",\n        \"dst_region\",\n        \"dst_timezone\",\n        \"dst_zipcode\",\n        \"dstip\",\n        \"event_type\",\n        \"evt_src_chnl\",\n        \"file_size\",\n        \"hostname\",\n        \"instance_id\",\n        \"managed_app\",\n        \"managementID\",\n        \"md5\",\n        \"nsdeviceuid\",\n        \"object\",\n        \"object_id\",\n        \"object_type\",\n        \"organization_unit\",\n        \"orig_ty\",\n        \"os\",\n        \"os_version\",\n        \"other_categories\",\n        \"page\",\n        \"page_site\",\n        \"parent_id\",\n        \"policy\",\n        \"policy_actions\",\n        \"profile_id\",\n        \"referer\",\n        \"severity\",\n        \"site\",\n        \"slc_latitude\",\n        \"slc_longitude\",\n        \"src_country\",\n        \"src_geoip_src\",\n        \"src_latitude\",\n        \"src_location\",\n        \"src_longitude\",\n        \"src_region\",\n        \"src_timezone\",\n        \"src_zipcode\",\n        \"srcip\",\n        \"telemetry_app\",\n        \"threshold_time\",\n        \"timestamp\",\n        \"traffic_type\",\n        \"transaction_id\",\n        \"type\",\n        \"uba_ap1\",\n        \"uba_ap2\",\n        \"uba_inst1\",\n        \"uba_inst2\",\n        \"ur_normalized\",\n        \"url\",\n        \"user\",\n        \"userip\",\n        \"userkey\"\n    }\n}\n\nlocal QUARANTINE_FIELD_ORDERS = {\n    root = {\n        \"_id\",\n        \"access_method\",\n        \"acked\",\n        \"action\",\n        \"alert\",\n        \"alert_name\",\n        \"alert_type\",\n        \"app\",\n        \"appcategory\",\n        \"browser\",\n        \"category\",\n        \"cci\",\n        \"ccl\",\n        \"count\",\n        \"device\",\n        \"exposure\",\n        \"file_path\",\n        \"file_size\",\n        \"file_type\",\n        \"instance_id\",\n        \"md5\",\n        \"mime_type\",\n        \"modified\",\n        \"object\",\n        \"object_id\",\n        \"object_type\",\n        \"organization_unit\",\n        \"os\",\n        \"other_categories\",\n        \"owner\",\n        \"policy\",\n        \"scan_type\",\n        \"site\",\n        \"suppression_key\",\n        \"timestamp\",\n        \"traffic_type\",\n        \"type\",\n        \"ur_normalized\",\n        \"url\",\n        \"user\",\n        \"userkey\",\n        \"q_original_version\",\n        \"q_original_filename\",\n        \"user_id\",\n        \"quarantine_profile_id\",\n        \"q_app\",\n        \"department\",\n        \"quarantine_file_name\",\n        \"shared_with\",\n        \"profile_emails\",\n        \"q_admin\",\n        \"from_user\",\n        \"manager\",\n        \"quarantine_file_id\",\n        \"quarantine_profile\",\n        \"q_original_shared\",\n        \"file_id\",\n        \"departmentNumber\",\n        \"orignal_file_path\",\n        \"q_original_filepath\",\n        \"q_instance\",\n        \"dlp_profile\"\n    }\n}\n\nlocal COMPROMISED_CREDENTIAL_FIELD_ORDERS = {\n    root = {\n        \"_id\",\n        \"_insertion_epoch_timestamp\",\n        \"_service_identifier\",\n        \"acked\",\n        \"alert\",\n        \"alert_name\",\n        \"alert_type\",\n        \"app\",\n        \"breach_date\",\n        \"breach_description\",\n        \"breach_id\",\n        \"breach_media_references\",\n        \"breach_score\",\n        \"breach_target_references\",\n        \"category\",\n        \"cci\",\n        \"ccl\",\n        \"count\",\n        \"email_source\",\n        \"external_email\",\n        \"matched_username\",\n        \"organization_unit\",\n        \"other_categories\",\n        \"password_type\",\n        \"timestamp\",\n        \"type\",\n        \"ur_normalized\",\n        \"user\",\n        \"userkey\"\n    }\n}\n\n\nARRAY_FIELDS = {\n    other_categories = true,\n    profile_emails = true,\n}\n\n-- Optimized JSON encoding function with predefined ordering\nfunction encodeJson(obj, key, field_orders)\n  if obj == nil or obj == \"NULL_PLACEHOLDER\" then\n    return \"null\"\n  elseif type(obj) == \"boolean\" then\n    return tostring(obj)\n  elseif type(obj) == \"number\" then\n    return tostring(obj)\n  elseif type(obj) == \"string\" then\n    return '\"' .. obj:gsub('\"', '\\\\\"') .. '\"'\n  elseif type(obj) == \"table\" then\n    local isArray = true\n    local maxIndex = 0\n    for k, v in pairs(obj) do\n      if type(k) ~= \"number\" then\n        isArray = false\n        break\n      end\n      maxIndex = math.max(maxIndex, k)\n    end\n    \n    if isArray and maxIndex > 0 then\n      local items = {}\n      for i = 1, maxIndex do\n        -- Use the parent key for predefined ordering if available\n        local elementKey = key or tostring(i)\n        table.insert(items, obj[i] ~= nil and encodeJson(obj[i], elementKey, field_orders) or \"null\")\n      end\n      return \"[\" .. table.concat(items, \", \") .. \"]\"\n    elseif isArray and ARRAY_FIELDS[key] == true then\n      -- case of empty array []\n      return \"[]\"\n    else\n      local items = {}\n      local fieldOrder = field_orders[key] or {}\n      \n      -- Phase 1: Process fields in predefined order\n      for _, fieldName in ipairs(fieldOrder) do\n        local v = obj[fieldName]\n        if v ~= nil then\n          table.insert(items, '\"' .. fieldName:gsub('\"', '\\\\\"') .. '\": ' .. encodeJson(v, fieldName, field_orders))\n        else \n          table.insert(items, '\"' .. fieldName:gsub('\"', '\\\\\"') .. '\": ' .. \"null\")\n        end\n      end\n      \n      -- Phase 2: Process remaining fields\n      for k, v in pairs(obj) do\n        local found = false\n        for _, fieldName in ipairs(fieldOrder) do\n          if k == fieldName then \n            found = true\n            break\n          end\n        end\n        if not found then\n          local keyStr = type(k) == \"string\" and k or tostring(k)\n          table.insert(items, '\"' .. keyStr:gsub('\"', '\\\\\"') .. '\": ' .. encodeJson(v, keyStr, field_orders))\n        end\n      end\n      \n      return \"{\" .. table.concat(items, \", \") .. \"}\"\n    end\n  else\n    return '\"' .. tostring(obj) .. '\"'\n  end\nend\n\n\nfunction setNestedField(obj, path, value)\n    if value == nil or path == nil or path == '' then return end\n\n    local keys = {}\n    for key in string.gmatch(path, '[^.]+') do\n        if key and key ~= '' then\n            table.insert(keys, key)\n        end\n    end\n\n    if #keys == 0 then return end\n\n    local current = obj\n    for i = 1, #keys - 1 do\n        local key = keys[i]\n        if key then\n            local arrayIndex = string.match(key, '(.-)%[(%d+)%]')\n            if arrayIndex then\n                local baseName = string.match(key, '(.-)%[')\n                local index = tonumber(string.match(key, '%[(%d+)%]')) + 1\n                if current[baseName] == nil then\n                    current[baseName] = {}\n                end\n                if current[baseName][index] == nil then\n                    current[baseName][index] = {}\n                end\n                current = current[baseName][index]\n            else\n                if current[key] == nil then\n                    current[key] = {}\n                end\n                current = current[key]\n            end\n        end\n    end\n\n    local finalKey = keys[#keys]\n    if finalKey then\n        local arrayIndex = string.match(finalKey, '(.-)%[(%d+)%]')\n        if arrayIndex then\n            local baseName = string.match(finalKey, '(.-)%[')\n            local index = tonumber(string.match(finalKey, '%[(%d+)%]')) + 1\n            if current[baseName] == nil then\n                current[baseName] = {}\n            end\n            current[baseName][index] = value\n        else\n            current[finalKey] = value\n        end\n    end\nend\n\nfunction getNestedField(obj, path)\n    if obj == nil or path == nil or path == '' then return nil end\n\n    local keys = {}\n    for key in string.gmatch(path, '[^.]+') do\n        if key and key ~= '' then\n            table.insert(keys, key)\n        end\n    end\n\n    if #keys == 0 then return nil end\n\n    local current = obj\n    for _, key in ipairs(keys) do\n        if current == nil or key == nil then return nil end\n\n        local arrayIndex = string.match(key, '(.-)%[(%d+)%]')\n        if arrayIndex then\n            local baseName = string.match(key, '(.-)%[')\n            local index = tonumber(string.match(key, '%[(%d+)%]')) + 1\n            if current[baseName] == nil or current[baseName][index] == nil then\n                return nil\n            end\n            current = current[baseName][index]\n        else\n            if current[key] == nil then\n                return nil\n            end\n            current = current[key]\n        end\n    end\n    return current\nend\n\nfunction copyField(source, target, sourcePath, targetPath)\n    if source == nil or target == nil or sourcePath == nil or targetPath == nil then\n        return\n    end\n    if sourcePath == '' or targetPath == '' then\n        return\n    end\n    local value = getNestedField(source, sourcePath)\n    if value ~= nil then\n        setNestedField(target, targetPath, value)\n    end\nend\n\nfunction getValue(tbl, key, default)\n    local value = tbl[key]\n    if value == nil then\n        return default\n    else\n        return value\n    end\nend\n\nfunction getDefaultMapping(event)\n    local alertType = getValue(event, \"alert_type\", \"Other\")\n    local result = {}\n    result.activity_id = 99\n    result.metadata = {product = {name = \"Netskope\"}}\n    result.metadata.product.vendor_name = \"Netskope\"\n    result.metadata.version = \"1.0.0\"\n    result.severity_id = 0\n    result.dataSource = {category = \"security\", name = \"Netskope\", vendor = \"Netskope\"}\n    result.event = {type = alertType}\n    result.activity_name = alertType\n    return result\nend\n \nfunction getDlpEvents(event)\n    local result = getDefaultMapping(event)\n    result.class_uid = 2001\n    result.class_name = \"Security Finding\"\n    result.category_uid = 2\n    result.category_name = \"Findings\"\n    result.type_uid = 200199\n    result.type_name = \"Security Finding: Other\"\n\n    result.resources = {\n        {\n            data = {\n                page = getValue(event, \"page\", nil),\n                page_site = getValue(event, \"page_site\", nil)\n            },\n        },\n        {\n            name = getValue(event, \"object\", nil)\n        },\n        {\n            uid = getValue(event, \"object_id\", nil)\n        },\n        {\n            type = getValue(event, \"object_type\", nil)\n        },\n        {\n            owner = {\n                group = getValue(event, \"organization_unit\", nil),\n            }\n        },\n        {\n            owner = {\n                email_addr = getValue(event, \"from_user\", nil)\n            }\n        }\n    }\n    \n    local fieldMappings = {\n        {source='__cookie_uid', target='unmapped.__cookie_uid'},\n        {source='_category_id', target='unmapped._category_id'},\n        {source='_category_tags', target='unmapped._category_tags'},\n        {source='_client_file_type', target='unmapped._client_file_type'},\n        {source='_correlation_id', target='metadata.correlation_uid'},\n        {source='_ef_received_at', target='unmapped._ef_received_at'},\n        {source='_event_id', target='unmapped._event_id'},\n        {source='_forwarded_by', target='unmapped._forwarded_by'},\n        {source='_gef_src_dp', target='unmapped._gef_src_dp'},\n        {source='_id', target='unmapped._id'},\n        {source='_insertion_epoch_timestamp', target='unmapped._insertion_epoch_timestamp'},\n        {source='_nshostname', target='unmapped._nshostname'},\n        {source='_raw_event_inserted_at', target='unmapped._raw_event_inserted_at'},\n        {source='_resource_name', target='resource.name'},\n        {source='_service_identifier', target='unmapped._service_identifier'},\n        {source='_skip_geoip_lookup', target='unmapped._skip_geoip_lookup'},\n        {source='_src_epoch_now', target='unmapped._src_epoch_now'},\n        {source='access_method', target='unmapped.access_method'},\n        {source='acked', target='unmapped.acked'},\n        {source='action', target='unmapped.action'},\n        {source='activity', target='unmapped.activity'},\n        {source='alert', target='unmapped.alert'},\n        {source='alert_name', target='finding.title'},\n        {source='alert_type', target='unmapped.alert_type'},\n        {source='app', target='unmapped.app'},\n        {source='app_session_id', target='unmapped.app_session_id'},\n        {source='appcategory', target='unmapped.appcategory'},\n        {source='appsuite', target='unmapped.appsuite'},\n        {source='browser', target='unmapped.browser'},\n        {source='browser_session_id', target='unmapped.browser_session_id'},\n        {source='browser_version', target='unmapped.browser_version'},\n        {source='category', target='unmapped.category'},\n        {source='cci', target='unmapped.cci'},\n        {source='ccl', target='unmapped.ccl'},\n        {source='connection_id', target='unmapped.connection_id'},\n        {source='count', target='count'},\n        {source='device', target='unmapped.device'},\n        {source='device_classification', target='unmapped.device_classification'},\n        {source='dlp_file', target='unmapped.dlp_file'},\n        {source='dlp_incident_id', target='unmapped.dlp_incident_id'},\n        {source='dlp_is_unique_count', target='unmapped.dlp_is_unique_count'},\n        {source='dlp_parent_id', target='unmapped.dlp_parent_id'},\n        {source='dlp_profile', target='unmapped.dlp_profile'},\n        {source='dlp_rule', target='unmapped.dlp_rule'},\n        {source='dlp_rule_count', target='unmapped.dlp_rule_count'},\n        {source='dlp_rule_severity', target='unmapped.dlp_rule_severity'},\n        {source='dst_country', target='unmapped.dst_country'},\n        {source='dst_geoip_src', target='unmapped.dst_geoip_src'},\n        {source='dst_latitude', target='unmapped.dst_latitude'},\n        {source='dst_location', target='unmapped.dst_location'},\n        {source='dst_longitude', target='unmapped.dst_longitude'},\n        {source='dst_region', target='unmapped.dst_region'},\n        {source='dst_timezone', target='unmapped.dst_timezone'},\n        {source='dst_zipcode', target='unmapped.dst_zipcode'},\n        {source='dstip', target='unmapped.dstip'},\n        {source='file_lang', target='unmapped.file_lang'},\n        {source='file_size', target='unmapped.file_size'},\n        {source='file_type', target='unmapped.file_type'},\n        {source='incident_id', target='finding.uid'},\n        {source='instance_id', target='unmapped.instance_id'},\n        {source='local_sha256', target='unmapped.local_sha256'},\n        {source='managed_app', target='unmapped.managed_app'},\n        {source='managementID', target='unmapped.managementID'},\n        {source='md5', target='unmapped.md5'},\n        {source='netskope_pop', target='unmapped.netskope_pop'},\n        {source='nsdeviceuid', target='unmapped.nsdeviceuid'},\n        {source='os', target='unmapped.os'},\n        {source='os_version', target='unmapped.os_version'},\n        {source='other_categories', target='unmapped.other_categories'},\n        {source='policy', target='analytic.name'},\n        {source='policy_id', target='analytic.uid'},\n        {source='protocol', target='unmapped.protocol'},\n        {source='referer', target='unmapped.referer'},\n        {source='request_id', target='unmapped.request_id'},\n        {source='sanctioned_instance', target='unmapped.sanctioned_instance'},\n        {source='severity', target='unmapped.severity'},\n        {source='site', target='unmapped.site'},\n        {source='src_country', target='unmapped.src_country'},\n        {source='src_geoip_src', target='unmapped.src_geoip_src'},\n        {source='src_latitude', target='unmapped.src_latitude'},\n        {source='src_location', target='unmapped.src_location'},\n        {source='src_longitude', target='unmapped.src_longitude'},\n        {source='src_region', target='unmapped.src_region'},\n        {source='src_time', target='unmapped.src_time'},\n        {source='src_timezone', target='unmapped.src_timezone'},\n        {source='src_zipcode', target='unmapped.src_zipcode'},\n        {source='srcip', target='unmapped.srcip'},\n        {source='suppression_key', target='unmapped.suppression_key'},\n        {source='timestamp', target='unmapped.timestamp'},\n        {source='traffic_type', target='unmapped.traffic_type'},\n        {source='transaction_id', target='unmapped.transaction_id'},\n        {source='true_obj_category', target='unmapped.true_obj_category'},\n        {source='true_obj_type', target='unmapped.true_obj_type'},\n        {source='tss_mode', target='unmapped.tss_mode'},\n        {source='type', target='unmapped.type'},\n        {source='ur_normalized', target='unmapped.ur_normalized'},\n        {source='url', target='unmapped.url'},\n        {source='user', target='unmapped.user'},\n        {source='userip', target='unmapped.userip'},\n        {source='userkey', target='unmapped.userkey'},\n        {source='metadata.product.name', target='metadata.product.name'},\n        {source='metadata.product.vendor_name', target='metadata.product.vendor_name'},\n        {source='metadata.version', target='metadata.version'},\n        {source='dataSource.category', target='dataSource.category'},\n        {source='dataSource.name', target='dataSource.name'},\n        {source='dataSource.vendor', target='dataSource.vendor'},\n        {source='class_uid', target='class_uid'},\n        {source='class_name', target='class_name'},\n        {source='category_uid', target='category_uid'},\n        {source='category_name', target='category_name'},\n        {source='type_uid', target='type_uid'},\n        {source='type_name', target='type_name'},\n        {source='activity_name', target='activity_name'},\n        {source='activity_id', target='activity_id'},\n        {source='severity_id', target='severity_id'},\n        {source='message', target='message'},\n        {source='resources', target='resources'},\n        {source='hostname', target='unmapped.hostname'},\n    }\n\n    for _, mapping in ipairs(fieldMappings) do\n        copyField(event, result, mapping.source, mapping.target)\n    end\n\n    result = copyUnmappedFields(event, fieldMappings, result)\n    return result\nend\n\nfunction getUbaEvents(event)\n    local result = getDefaultMapping(event)\n    result.class_uid = 2001\n    result.class_name = \"Security Finding\"\n    result.category_uid = 2\n    result.category_name = \"Findings\"\n    result.type_uid = 200199\n    result.type_name = \"Security Finding: Other\"\n    result.resources = {\n        {\n            data = {\n                hostname = getValue(event, \"hostname\", nil)\n            }\n        },\n        {\n            name = getValue(event, \"object\", nil)\n        },\n        {\n            uid = getValue(event, \"object_id\", nil)\n        },\n        {\n            type = getValue(event, \"object_type\", nil)\n        },\n        {\n            owner = {\n                email_addr = getValue(event, \"ur_normalized\", nil)\n            }\n        },\n    }\n\n    local fieldMappings = {\n            {source='unmapped._category_id', target='unmapped._category_id'},\n            {source='unmapped._category_tags', target='unmapped._category_tags'},\n            {source='_correlation_id', target='metadata.correlation_uid'},\n            {source='unmapped._ef_received_at', target='unmapped._ef_received_at'},\n            {source='unmapped._event_id', target='unmapped._event_id'},\n            {source='unmapped._forwarded_by', target='unmapped._forwarded_by'},\n            {source='_gef_src_dp', target='unmapped._gef_src_dp'},\n            {source='_id', target='unmapped._id'},\n            {source='_insertion_epoch_timestamp', target='unmapped._insertion_epoch_timestamp'},\n            {source='_raw_event_inserted_at', target='unmapped._raw_event_inserted_at'},\n            {source='_service_identifier', target='unmapped._service_identifier'},\n            {source='_session_begin', target='unmapped._session_begin'},\n            {source='access_method', target='unmapped.access_method'},\n            {source='acked', target='unmapped.acked'},\n            {source='action', target='analytic.type'},\n            {source='activity', target='unmapped.activity'},\n            {source='alert', target='unmapped.alert'},\n            {source='alert_id', target='finding.uid'},\n            {source='alert_name', target='finding.title'},\n            {source='alert_type', target='finding.type'},\n            {source='app', target='unmapped.app'},\n            {source='app_session_id', target='unmapped.app_session_id'},\n            {source='appcategory', target='unmapped.appcategory'},\n            {source='browser', target='unmapped.browser'},\n            {source='browser_session_id', target='unmapped.browser_session_id'},\n            {source='browser_version', target='unmapped.browser_version'},\n            {source='category', target='unmapped.category'},\n            {source='ccl', target='unmapped.ccl'},\n            {source='connection_id', target='unmapped.connection_id'},\n            {source='count', target='count'},\n            {source='device', target='unmapped.device'},\n            {source='download_app', target='unmapped.download_app'},\n            {source='dst_country', target='unmapped.dst_country'},\n            {source='dst_geoip_src', target='unmapped.dst_geoip_src'},\n            {source='dst_latitude', target='unmapped.dst_latitude'},\n            {source='dst_location', target='unmapped.dst_location'},\n            {source='dst_longitude', target='unmapped.dst_longitude'},\n            {source='dst_region', target='unmapped.dst_region'},\n            {source='dst_timezone', target='unmapped.dst_timezone'},\n            {source='dst_zipcode', target='unmapped.dst_zipcode'},\n            {source='dstip', target='unmapped.dstip'},\n            {source='evt_src_chnl', target='unmapped.evt_src_chnl'},\n            {source='file_size', target='unmapped.file_size'},\n            {source='instance_id', target='unmapped.instance_id'},\n            {source='managed_app', target='unmapped.managed_app'},\n            {source='managementID', target='unmapped.managementID'},\n            {source='md5', target='unmapped.md5'},\n            {source='nsdeviceuid', target='unmapped.nsdeviceuid'},\n            {source='organization_unit', target='unmapped.organization_unit'},\n            {source='orig_ty', target='unmapped.orig_ty'},\n            {source='os', target='unmapped.os'},\n            {source='os_version', target='unmapped.os_version'},\n            {source='other_categories', target='unmapped.other_categories'},\n            {source='page', target='unmapped.page'},\n            {source='page_site', target='unmapped.page_site'},\n            {source='parent_id', target='unmapped.parent_id'},\n            {source='policy', target='unmapped.policy'},\n            {source='policy_actions', target='unmapped.policy_actions'},\n            {source='profile_id', target='unmapped.profile_id'},\n            {source='referer', target='unmapped.referer'},\n            {source='severity', target='unmapped.severity'},\n            {source='site', target='unmapped.site'},\n            {source='slc_latitude', target='unmapped.slc_latitude'},\n            {source='slc_longitude', target='unmapped.slc_longitude'},\n            {source='src_country', target='unmapped.src_country'},\n            {source='src_geoip_src', target='unmapped.src_geoip_src'},\n            {source='src_latitude', target='unmapped.src_latitude'},\n            {source='src_location', target='unmapped.src_location'},\n            {source='src_longitude', target='unmapped.src_longitude'},\n            {source='src_region', target='unmapped.src_region'},\n            {source='src_timezone', target='unmapped.src_timezone'},\n            {source='src_zipcode', target='unmapped.src_zipcode'},\n            {source='srcip', target='unmapped.srcip'},\n            {source='telemetry_app', target='unmapped.telemetry_app'},\n            {source='threshold_time', target='unmapped.threshold_time'},\n            {source='timestamp', target='metadata.original_time'},\n            {source='traffic_type', target='unmapped.traffic_type'},\n            {source='transaction_id', target='unmapped.transaction_id'},\n            {source='type', target='unmapped.type'},\n            {source='uba_ap1', target='unmapped.uba_ap1'},\n            {source='uba_ap2', target='unmapped.uba_ap2'},\n            {source='uba_inst1', target='unmapped.uba_inst1'},\n            {source='uba_inst2', target='unmapped.uba_inst2'},\n            {source='url', target='unmapped.url'},\n            {source='user', target='unmapped.user'},\n            {source='userip', target='unmapped.userip'},\n            {source='userkey', target='unmapped.userkey'},\n            {source='metadata.product.name', target='metadata.product.name'},\n            {source='metadata.product.vendor_name', target='metadata.product.vendor_name'},\n            {source='metadata.version', target='metadata.version'},\n            {source='dataSource.category', target='dataSource.category'},\n            {source='dataSource.name', target='dataSource.name'},\n            {source='dataSource.vendor', target='dataSource.vendor'},\n            {source='class_uid', target='class_uid'},\n            {source='class_name', target='class_name'},\n            {source='category_uid', target='category_uid'},\n            {source='category_name', target='category_name'},\n            {source='type_uid', target='type_uid'},\n            {source='type_name', target='type_name'},\n            {source='activity_name', target='activity_name'},\n            {source='activity_id', target='activity_id'},\n            {source='severity_id', target='severity_id'},\n            {source='message', target='message'},\n            {source='resources', target='resources'},\n        }\n    \n    for _, mapping in ipairs(fieldMappings) do\n        copyField(event, result, mapping.source, mapping.target)\n    end\n\n    result = copyUnmappedFields(event, fieldMappings, result)\n    return result\nend\n\nfunction getCompromisedCredentialEvents(event)\n    local result = getDefaultMapping(event)\n    result[\"class_uid\"] = 2001\n    result[\"class_name\"] = \"Security Finding\"\n    result[\"category_uid\"] = 2\n    result[\"category_name\"] = \"Findings\"\n    result[\"type_uid\"] = 200199\n    result[\"type_name\"] = \"Security Finding: Other\"\n    result[\"resources\"] = {\n        {\n            data = {\n                breach_id = getValue(event, \"breach_id\", nil),\n                breach_target_references = getValue(event, \"breach_target_references\", nil),\n                breach_description = getValue(event, \"breach_description\", nil),\n                breach_date = getValue(event, \"breach_date\", nil),\n                breach_media_references = getValue(event, \"breach_media_references\", nil),\n                breach_score = getValue(event, \"breach_score\", nil),\n            }\n        },\n        {owner = {email_addr = getValue(event, \"ur_normalized\", nil)}},\n    }\n    local fieldMappings = {\n        {source='alert', target='unmapped.alert'},\n        {source='alert_name', target='finding.title'},\n        {source='alert_type', target='finding.type'},\n        {source='_id', target='unmapped._id'},\n        {source='_insertion_epoch_timestamp', target='unmapped._insertion_epoch_timestamp'},\n        {source='_service_identifier', target='unmapped._service_identifier'},\n        {source='acked', target='unmapped.acked'},\n        {source='alert_type', target='finding.type'},\n        {source='app', target='unmapped.app'},\n        {source='category', target='unmapped.category'},\n        {source='cci', target='unmapped.cci'},\n        {source='ccl', target='unmapped.ccl'},\n        {source='count', target='count'},\n        {source='email_source', target='unmapped.email_source'},\n        {source='external_email', target='unmapped.external_email'},\n        {source='matched_username', target='unmapped.matched_username'},\n        {source='organization_unit', target='unmapped.organization_unit'},\n        {source='other_categories', target='unmapped.other_categories'},\n        {source='password_type', target='unmapped.password_type'},\n        {source='timestamp', target='metadata.original_time'},\n        {source='type', target='analytic.type'},\n        {source='user', target='unmapped.user'},\n        {source='userkey', target='unmapped.userkey'},\n        {source='metadata.product.name', target='metadata.product.name'},\n        {source='metadata.product.vendor_name', target='metadata.product.vendor_name'},\n        {source='metadata.version', target='metadata.version'},\n        {source='dataSource.category', target='dataSource.category'},\n        {source='dataSource.name', target='dataSource.name'},\n        {source='dataSource.vendor', target='dataSource.vendor'},\n        {source='class_uid', target='class_uid'},\n        {source='class_name', target='class_name'},\n        {source='category_uid', target='category_uid'},\n        {source='category_name', target='category_name'},\n        {source='type_uid', target='type_uid'},\n        {source='type_name', target='type_name'},\n        {source='activity_name', target='activity_name'},\n        {source='activity_id', target='activity_id'},\n        {source='severity_id', target='severity_id'},\n        {source='message', target='message'},\n        {source='resources', target='resources'},\n    }\n    for _, mapping in ipairs(fieldMappings) do\n        copyField(event, result, mapping.source, mapping.target)\n    end\n\n    result = copyUnmappedFields(event, fieldMappings, result)\n    return result\nend\n\nfunction getMalsiteEvents(event)\n    local result = getDefaultMapping(event)\n    result[\"class_uid\"] = 2001\n    result[\"class_name\"] = \"Security Finding\"\n    result[\"category_uid\"] = 2\n    result[\"category_name\"] = \"Findings\"\n    result[\"type_uid\"] = 200199\n    result[\"type_name\"] = \"Security Finding: Other\"\n    result[\"resources\"] = {\n        {\n            data = {\n                hostname = getValue(event, \"hostname\", nil),\n                page = getValue(event, \"page\", nil),\n                page_site = getValue(event, \"page_site\", nil),\n            }\n        },\n        {type = getValue(event, \"threat_match_field\", nil)},\n        {name = getValue(event, \"threat_match_value\", nil)},\n        {uid = getValue(event, \"threat_source_id\", nil)},\n    }\n    local fieldMappings = {\n            {source = \"_appsession_start\", target = \"unmapped._appsession_start\"},\n            {source = \"_category_id\", target = \"unmapped._category_id\"},\n            {source = \"_category_tags\", target = \"unmapped._category_tags\"},\n            {source = \"_correlation_id\", target = \"metadata.correlation_uid\"},\n            {source = \"_creation_timestamp\", target = \"unmapped._creation_timestamp\"},\n            {source = \"_ef_received_at\", target = \"unmapped._ef_received_at\"},\n            {source = \"_event_id\", target = \"unmapped._event_id\"},\n            {source = \"_forwarded_by\", target = \"unmapped._forwarded_by\"},\n            {source = \"_gef_src_dp\", target = \"unmapped._gef_src_dp\"},\n            {source = \"_id\", target = \"unmapped._id\"},\n            {source = \"_insertion_epoch_timestamp\", target = \"unmapped._insertion_epoch_timestamp\"},\n            {source = \"_nshostname\", target = \"unmapped._nshostname\"},\n            {source = \"_policy_category_id\", target = \"unmapped._policy_category_id\"},\n            {source = \"_raw_event_inserted_at\", target = \"unmapped._raw_event_inserted_at\"},\n            {source = \"_service_identifier\", target = \"unmapped._service_identifier\"},\n            {source = \"_skip_geoip_lookup\", target = \"unmapped._skip_geoip_lookup\"},\n            {source = \"_src_epoch_now\", target = \"unmapped._src_epoch_now\"},\n            {source = \"access_method\", target = \"unmapped.access_method\"},\n            {source = \"acked\", target = \"unmapped.acked\"},\n            {source = \"action\", target = \"unmapped.action\"},\n            {source = \"alert\", target = \"unmapped.alert\"},\n            {source = \"alert_name\", target = \"unmapped.alert_name\"},\n            {source = \"alert_type\", target = \"unmapped.alert_type\"},\n            {source = \"app\", target = \"unmapped.app\"},\n            {source = \"app_session_id\", target = \"unmapped.app_session_id\"},\n            {source = \"appcategory\", target = \"unmapped.appcategory\"},\n            {source = \"browser\", target = \"unmapped.browser\"},\n            {source = \"browser_session_id\", target = \"unmapped.browser_session_id\"},\n            {source = \"browser_version\", target = \"unmapped.browser_version\"},\n            {source = \"category\", target = \"unmapped.category\"},\n            {source = \"cci\", target = \"unmapped.cci\"},\n            {source = \"ccl\", target = \"unmapped.ccl\"},\n            {source = \"connection_id\", target = \"unmapped.connection_id\"},\n            {source = \"count\", target = \"count\"},\n            {source = \"device\", target = \"unmapped.device\"},\n            {source = \"device_classification\", target = \"unmapped.device_classification\"},\n            {source = \"domain\", target = \"unmapped.domain\"},\n            {source = \"dst_country\", target = \"unmapped.dst_country\"},\n            {source = \"dst_latitude\", target = \"unmapped.dst_latitude\"},\n            {source = \"dst_location\", target = \"unmapped.dst_location\"},\n            {source = \"dst_longitude\", target = \"unmapped.dst_longitude\"},\n            {source = \"dst_region\", target = \"unmapped.dst_region\"},\n            {source = \"dst_timezone\", target = \"unmapped.dst_timezone\"},\n            {source = \"dst_zipcode\", target = \"unmapped.dst_zipcode\"},\n            {source = \"dstip\", target = \"unmapped.dstip\"},\n            {source = \"incident_id\", target = \"finding.uid\"},\n            {source = \"ja3\", target = \"unmapped.ja3\"},\n            {source = \"ja3s\", target = \"unmapped.ja3s\"},\n            {source = \"malicious\", target = \"unmapped.malicious\"},\n            {source = \"malsite_category\", target = \"unmapped.malsite_category\"},\n            {source = \"malsite_country\", target = \"unmapped.malsite_country\"},\n            {source = \"malsite_id\", target = \"malware.uid\"},\n            {source = \"malsite_ip_host\", target = \"unmapped.malsite_ip_host\"},\n            {source = \"malsite_latitude\", target = \"unmapped.malsite_latitude\"},\n            {source = \"malsite_longitude\", target = \"unmapped.malsite_longitude\"},\n            {source = \"malsite_region\", target = \"unmapped.malsite_region\"},\n            {source = \"managed_app\", target = \"unmapped.managed_app\"},\n            {source = \"netskope_pop\", target = \"unmapped.netskope_pop\"},\n            {source = \"organization_unit\", target = \"unmapped.organization_unit\"},\n            {source = \"os\", target = \"unmapped.os\"},\n            {source = \"os_version\", target = \"unmapped.os_version\"},\n            {source = \"other_categories\", target = \"unmapped.other_categories\"},\n            {source = \"Security\", target = \"unmapped.security_risk\"},\n            {source = \"policy\", target = \"unmapped.policy\"},\n            {source = \"policy_id\", target = \"unmapped.policy_id\"},\n            {source = \"port\", target = \"unmapped.port\"},\n            {source = \"protocol\", target = \"unmapped.protocol\"},\n            {source = \"referer\", target = \"unmapped.referer\"},\n            {source = \"request_id\", target = \"unmapped.request_id\"},\n            {source = \"severity\", target = \"unmapped.severity\"},\n            {source = \"severity_level\", target = \"unmapped.severity_level\"},\n            {source = \"severity_level_id\", target = \"unmapped.severity_level_id\"},\n            {source = \"site\", target = \"unmapped.site\"},\n            {source = \"src_country\", target = \"unmapped.src_country\"},\n            {source = \"src_latitude\", target = \"unmapped.src_latitude\"},\n            {source = \"src_location\", target = \"unmapped.src_location\"},\n            {source = \"src_longitude\", target = \"unmapped.src_longitude\"},\n            {source = \"src_region\", target = \"unmapped.src_region\"},\n            {source = \"src_time\", target = \"unmapped.src_time\"},\n            {source = \"src_timezone\", target = \"unmapped.src_timezone\"},\n            {source = \"src_zipcode\", target = \"unmapped.src_zipcode\"},\n            {source = \"srcip\", target = \"unmapped.srcip\"},\n            {source = \"telemetry_app\", target = \"unmapped.telemetry_app\"},\n            {source = \"timestamp\", target = \"metadata.original_time\"},\n            {source = \"traffic_type\", target = \"unmapped.traffic_type\"},\n            {source = \"transaction_id\", target = \"unmapped.transaction_id\"},\n            {source = \"type\", target = \"unmapped.type\"},\n            {source = \"ur_normalized\", target = \"unmapped.ur_normalized\"},\n            {source = \"url\", target = \"unmapped.url\"},\n            {source = \"user\", target = \"unmapped.user\"},\n            {source = \"userip\", target = \"unmapped.userip\"},\n            {source = \"userkey\", target = \"unmapped.userkey\"},\n            {source = \"metadata.product.name\", target = \"metadata.product.name\"},\n            {source = \"metadata.product.vendor_name\", target = \"metadata.product.vendor_name\"},\n            {source = \"metadata.version\", target = \"metadata.version\"},\n            {source = \"dataSource.category\", target = \"dataSource.category\"},\n            {source = \"dataSource.name\", target = \"dataSource.name\"},\n            {source = \"dataSource.vendor\", target = \"dataSource.vendor\"},\n            {source = \"class_uid\", target = \"class_uid\"},\n            {source = \"class_name\", target = \"class_name\"},\n            {source = \"category_uid\", target = \"category_uid\"},\n            {source = \"category_name\", target = \"category_name\"},\n            {source = \"type_uid\", target = \"type_uid\"},\n            {source = \"type_name\", target = \"type_name\"},\n            {source = \"activity_name\", target = \"activity_name\"},\n            {source = \"activity_id\", target = \"activity_id\"},\n            {source = \"severity_id\", target = \"severity_id\"},\n            {source = \"message\", target = \"message\"},\n            {source = \"resources\", target = \"resources\"},\n    }  \n    for _, mapping in ipairs(fieldMappings) do\n        copyField(event, result, mapping.source, mapping.target)\n    end\n\n    result = copyUnmappedFields(event, fieldMappings, result)\n    return result\nend\n\nfunction getMalwareEvents(event)\n    local result = getDefaultMapping(event)\n    result[\"class_uid\"] = 2001\n    result[\"class_name\"] = \"Security Finding\"\n    result[\"category_uid\"] = 2\n    result[\"category_name\"] = \"Findings\"\n    result[\"type_uid\"] = 200199\n    result[\"type_name\"] = \"Security Finding: Other\"\n    result[\"resources\"] = {\n        {\n            data = {\n                dstip = getValue(event, \"dstip\", nil),\n                file_category = getValue(event, \"file_category\", nil),\n                file_id = getValue(event, \"file_id\", nil),\n                hostname = getValue(event, \"hostname\", nil),\n                url = getValue(event, \"url\", nil),\n                user_id = getValue(event, \"user_id\", nil),\n            }\n        },\n        {name = getValue(event, \"file_name\", nil)},\n        {owner = {email_addr = getValue(event, \"ur_normalized\", nil)}},\n    }\n    local fieldMappings = {\n            {source=\"_body_size\", target=\"unmapped._body_size\"},\n            {source=\"_category_id\", target=\"unmapped._category_id\"},\n            {source=\"_category_tags\", target=\"unmapped._category_tags\"},\n            {source=\"_correlation_id\", target=\"metadata.correlation_uid\"},\n            {source=\"_detection_name\", target=\"unmapped._detection_name\"},\n            {source=\"_ef_received_at\", target=\"unmapped._ef_received_at\"},\n            {source=\"_event_id\", target=\"unmapped._event_id\"},\n            {source=\"_forwarded_by\", target=\"unmapped._forwarded_by\"},\n            {source=\"_gef_src_dp\", target=\"unmapped._gef_src_dp\"},\n            {source=\"_home_pop_name\", target=\"unmapped._home_pop_name\"},\n            {source=\"_id\", target=\"unmapped._id\"},\n            {source=\"_insertion_epoch_timestamp\", target=\"unmapped._insertion_epoch_timestamp\"},\n            {source=\"_internal_detection_engine\", target=\"unmapped._internal_detection_engine\"},\n            {source=\"_org_hash\", target=\"unmapped._org_hash\"},\n            {source=\"_raw_event_inserted_at\", target=\"unmapped._raw_event_inserted_at\"},\n            {source=\"_resource_name\", target=\"unmapped._resource_name\"},\n            {source=\"_service_identifier\", target=\"unmapped._service_identifier\"},\n            {source=\"_src_epoch_now\", target=\"unmapped._src_epoch_now\"},\n            {source=\"access_method\", target=\"unmapped.access_method\"},\n            {source=\"acked\", target=\"unmapped.acked\"},\n            {source=\"action\", target=\"unmapped.action\"},\n            {source=\"activity\", target=\"unmapped.activity\"},\n            {source=\"alert\", target=\"unmapped.alert\"},\n            {source=\"alert_name\", target=\"malware.name\"},\n            {source=\"alert_type\", target=\"finding.type\"},\n            {source=\"app\", target=\"unmapped.app\"},\n            {source=\"app_name\", target=\"unmapped.app_name\"},\n            {source=\"app_session_id\", target=\"unmapped.app_session_id\"},\n            {source=\"appcategory\", target=\"unmapped.appcategory\"},\n            {source=\"browser\", target=\"unmapped.browser\"},\n            {source=\"browser_session_id\", target=\"unmapped.browser_session_id\"},\n            {source=\"browser_version\", target=\"unmapped.browser_version\"},\n            {source=\"category\", target=\"unmapped.category\"},\n            {source=\"cci\", target=\"unmapped.cci\"},\n            {source=\"ccl\", target=\"unmapped.ccl\"},\n            {source=\"connection_id\", target=\"unmapped.connection_id\"},\n            {source=\"count\", target=\"count\"},\n            {source=\"detection_engine\", target=\"unmapped.detection_engine\"},\n            {source=\"device\", target=\"unmapped.device\"},\n            {source=\"device_classification\", target=\"unmapped.device_classification\"},\n            {source=\"dst_country\", target=\"unmapped.dst_country\"},\n            {source=\"dst_geoip_src\", target=\"unmapped.dst_geoip_src\"},\n            {source=\"dst_latitude\", target=\"unmapped.dst_latitude\"},\n            {source=\"dst_location\", target=\"unmapped.dst_location\"},\n            {source=\"dst_longitude\", target=\"unmapped.dst_longitude\"},\n            {source=\"dst_region\", target=\"unmapped.dst_region\"},\n            {source=\"dst_timezone\", target=\"unmapped.dst_timezone\"},\n            {source=\"dst_zipcode\", target=\"unmapped.dst_zipcode\"},\n            {source=\"file_size\", target=\"unmapped.file_size\"},\n            {source=\"file_type\", target=\"unmapped.file_type\"},\n            {source=\"incident_id\", target=\"unmapped.incident_id\"},\n            {source=\"instance\", target=\"unmapped.instance\"},\n            {source=\"instance_id\", target=\"unmapped.instance_id\"},\n            {source=\"local_md5\", target=\"unmapped.local_md5\"},\n            {source=\"local_sha256\", target=\"unmapped.local_sha256\"},\n            {source=\"malware_id\", target=\"malware.uid\"},\n            {source=\"malware_name\", target=\"malware.name\"},\n            {source=\"malware_profile\", target=\"unmapped.malware_profile\"},\n            {source=\"malware_severity\", target=\"unmapped.malware_severity\"},\n            {source=\"malware_type\", target=\"malware.type\"},\n            {source=\"managed_app\", target=\"unmapped.managed_app\"},\n            {source=\"managementID\", target=\"unmapped.managementID\"},\n            {source=\"md5\", target=\"unmapped.md5\"},\n            {source=\"ml_detection\", target=\"unmapped.ml_detection\"},\n            {source=\"nsdeviceuid\", target=\"unmapped.nsdeviceuid\"},\n            {source=\"object\", target=\"unmapped.object\"},\n            {source=\"object_type\", target=\"unmapped.object_type\"},\n            {source=\"organization_unit\", target=\"unmapped.organization_unit\"},\n            {source=\"os\", target=\"unmapped.os\"},\n            {source=\"os_version\", target=\"unmapped.os_version\"},\n            {source=\"other_categories\", target=\"unmapped.other_categories\"},\n            {source=\"page\", target=\"unmapped.page\"},\n            {source=\"page_site\", target=\"unmapped.page_site\"},\n            {source=\"policy\", target=\"analytic.name\"},\n            {source=\"policy_id\", target=\"analytic.uid\"},\n            {source=\"protocol\", target=\"unmapped.protocol\"},\n            {source=\"request_id\", target=\"unmapped.request_id\"},\n            {source=\"sanctioned_instance\", target=\"unmapped.sanctioned_instance\"},\n            {source=\"scanner_result\", target=\"unmapped.scanner_result\"},\n            {source=\"severity\", target=\"unmapped.severity\"},\n            {source=\"site\", target=\"unmapped.site\"},\n            {source=\"src_country\", target=\"unmapped.src_country\"},\n            {source=\"src_geoip_src\", target=\"unmapped.src_geoip_src\"},\n            {source=\"src_latitude\", target=\"unmapped.src_latitude\"},\n            {source=\"src_location\", target=\"unmapped.src_location\"},\n            {source=\"src_longitude\", target=\"unmapped.src_longitude\"},\n            {source=\"src_region\", target=\"unmapped.src_region\"},\n            {source=\"src_time\", target=\"unmapped.src_time\"},\n            {source=\"src_timezone\", target=\"unmapped.src_timezone\"},\n            {source=\"src_zipcode\", target=\"unmapped.src_zipcode\"},\n            {source=\"srcip\", target=\"unmapped.srcip\"},\n            {source=\"timestamp\", target=\"unmapped.timestamp\"},\n            {source=\"title\", target=\"unmapped.title\"},\n            {source=\"traffic_type\", target=\"unmapped.traffic_type\"},\n            {source=\"transaction_id\", target=\"unmapped.transaction_id\"},\n            {source=\"true_filetype\", target=\"unmapped.true_filetype\"},\n            {source=\"tss_mode\", target=\"unmapped.tss_mode\"},\n            {source=\"type\", target=\"unmapped.type\"},\n            {source=\"userip\", target=\"unmapped.userip\"},\n            {source=\"userkey\", target=\"unmapped.userkey\"},\n            {source=\"metadata.product.name\", target=\"metadata.product.name\"},\n            {source=\"metadata.product.vendor_name\", target=\"metadata.product.vendor_name\"},\n            {source=\"metadata.version\", target=\"metadata.version\"},\n            {source=\"dataSource.category\", target=\"dataSource.category\"},\n            {source=\"dataSource.name\", target=\"dataSource.name\"},\n            {source=\"dataSource.vendor\", target=\"dataSource.vendor\"},\n            {source=\"class_uid\", target=\"class_uid\"},\n            {source=\"class_name\", target=\"class_name\"},\n            {source=\"category_uid\", target=\"category_uid\"},\n            {source=\"category_name\", target=\"category_name\"},\n            {source=\"type_uid\", target=\"type_uid\"},\n            {source=\"type_name\", target=\"type_name\"},\n            {source=\"activity_name\", target=\"activity_name\"},\n            {source=\"activity_id\", target=\"activity_id\"},\n            {source=\"severity_id\", target=\"severity_id\"},\n            {source=\"message\", target=\"message\"},\n            {source=\"resources\", target=\"resources\"},\n    }\n    for _, mapping in ipairs(fieldMappings) do\n        copyField(event, result, mapping.source, mapping.target)\n    end\n\n    result = copyUnmappedFields(event, fieldMappings, result)\n    return result\nend\n\nfunction getPolicyEvents(event)\n    local result = getDefaultMapping(event)\n    result[\"class_uid\"] = 6001\n    result[\"class_name\"] = \"Web Resources Activity\"\n    result[\"category_uid\"] = 6\n    result[\"category_name\"] = \"Application Activity\"\n    result[\"type_uid\"] = 600199\n    result[\"type_name\"] = \"Web Resources Activity: Other\"\n    result[\"dst_endpoint\"] = {location = {coordinates = {getValue(event, \"dst_latitude\", nil), getValue(event, \"dst_longitude\", nil)}}}\n    result[\"src_endpoint\"] = {location = {coordinates = {getValue(event, \"src_latitude\", nil), getValue(event, \"src_longitude\", nil)}}}\n    local fieldMappings = {\n        {source=\"_category_id\", target=\"unmapped._category_id\"},\n        {source=\"_category_name\", target=\"unmapped._category_name\"},\n        {source=\"_category_tags\", target=\"unmapped._category_tags\"},\n        {source=\"_content_version\", target=\"metadata.product.feature.version\"},\n        {source=\"_correlation_id\", target=\"metadata.correlation_uid\"},\n        {source=\"_creation_timestamp\", target=\"metadata.logged_time\"},\n        {source=\"_ef_received_at\", target=\"metadata.processed_time\"},\n        {source=\"_event_id\", target=\"metadata.uid\"},\n        {source=\"_forwarded_by\", target=\"metadata.log_provider\"},\n        {source=\"_gef_src_dp\", target=\"unmapped._gef_src_dp\"},\n        {source=\"_id\", target=\"unmapped._id\"},\n        {source=\"_insertion_epoch_timestamp\", target=\"unmapped._insertion_epoch_timestamp\"},\n        {source=\"_nshostname\", target=\"device.hostname\"},\n        {source=\"_nsp_dur_back\", target=\"unmapped._nsp_dur_back\"},\n        {source=\"_nsp_dur_front\", target=\"unmapped._nsp_dur_front\"},\n        {source=\"_nsp_retrans_back\", target=\"unmapped._nsp_retrans_back\"},\n        {source=\"_nsp_retrans_front\", target=\"unmapped._nsp_retrans_front\"},\n        {source=\"_nsp_rtt_back\", target=\"unmapped._nsp_rtt_back\"},\n        {source=\"_nsp_rtt_front\", target=\"unmapped._nsp_rtt_front\"},\n        {source=\"_raw_event_inserted_at\", target=\"unmapped._raw_event_inserted_at\"},\n        {source=\"_resource_name\", target=\"web_resources.name\"},\n        {source=\"_service_identifier\", target=\"unmapped._service_identifier\"},\n        {source=\"_session_begin\", target=\"unmapped._session_begin\"},\n        {source=\"_skip_geoip_lookup\", target=\"unmapped._skip_geoip_lookup\"},\n        {source=\"_src_epoch_now\", target=\"unmapped._src_epoch_now\"},\n        {source=\"access_method\", target=\"unmapped.access_method\"},\n        {source=\"acked\", target=\"unmapped.acked\"},\n        {source=\"action\", target=\"unmapped.action\"},\n        {source=\"activity\", target=\"unmapped.activity\"},\n        {source=\"alert\", target=\"unmapped.alert\"},\n        {source=\"alert_name\", target=\"unmapped.alert_name\"},\n        {source=\"alert_type\", target=\"unmapped.alert_type\"},\n        {source=\"app\", target=\"unmapped.app\"},\n        {source=\"app_session_id\", target=\"actor.session.uid\"},\n        {source=\"appcategory\", target=\"unmapped.app_category\"},\n        {source=\"browser\", target=\"unmapped.browser\"},\n        {source=\"browser_session_id\", target=\"unmapped.browser_session_id\"},\n        {source=\"browser_version\", target=\"unmapped.browser_version\"},\n        {source=\"category\", target=\"unmapped.category\"},\n        {source=\"cci\", target=\"unmapped.cci\"},\n        {source=\"ccl\", target=\"unmapped.ccl\"},\n        {source=\"connection_id\", target=\"unmapped.connection_id\"},\n        {source=\"count\", target=\"count\"},\n        {source=\"device\", target=\"device.os.type\"},\n        {source=\"device_classification\", target=\"unmapped.device_classification\"},\n        {source=\"domain\", target=\"src_endpoint.domain\"},\n        {source=\"dst_country\", target=\"dst_endpoint.location.country\"},\n        {source=\"dst_location\", target=\"dst_endpoint.location.city\"},\n        {source=\"dst_region\", target=\"dst_endpoint.location.region\"},\n        {source=\"dst_timezone\", target=\"unmapped.dst_timezone\"},\n        {source=\"dst_zipcode\", target=\"dst_endpoint.location.postal_code\"},\n        {source=\"dstip\", target=\"dst_endpoint.ip\"},\n        {source=\"file_size\", target=\"unmapped.file_size\"},\n        {source=\"file_type\", target=\"unmapped.file_type\"},\n        {source=\"hostname\", target=\"src_endpoint.hostname\"},\n        {source=\"incident_id\", target=\"metadata.event_code\"},\n        {source=\"ja3\", target=\"unmapped.ja3\"},\n        {source=\"ja3s\", target=\"unmapped.ja3s\"},\n        {source=\"managed_app\", target=\"unmapped.managed_app\"},\n        {source=\"managementID\", target=\"unmapped.managementID\"},\n        {source=\"md5\", target=\"unmapped.md5\"},\n        {source=\"netskope_pop\", target=\"unmapped.netskope_pop\"},\n        {source=\"nsdeviceuid\", target=\"unmapped.nsdeviceuid\"},\n        {source=\"object\", target=\"unmapped.object\"},\n        {source=\"object_type\", target=\"unmapped.object_type\"},\n        {source=\"organization_unit\", target=\"unmapped.organization_unit\"},\n        {source=\"os\", target=\"unmapped.os\"},\n        {source=\"os_version\", target=\"unmapped.os_version\"},\n        {source=\"other_categories\", target=\"unmapped.other_categories\"},\n        {source=\"page\", target=\"unmapped.page\"},\n        {source=\"page_site\", target=\"unmapped.page_site\"},\n        {source=\"policy\", target=\"actor.authorizations.policy.name\"},\n        {source=\"policy_id\", target=\"actor.authorizations.policy.uid\"},\n        {source=\"port\", target=\"src_endpoint.port\"},\n        {source=\"protocol\", target=\"unmapped.protocol\"},\n        {source=\"request_id\", target=\"unmapped.request_id\"},\n        {source=\"severity\", target=\"unmapped.severity\"},\n        {source=\"site\", target=\"unmapped.site\"},\n        {source=\"src_country\", target=\"src_endpoint.location.country\"},\n        {source=\"src_location\", target=\"src_endpoint.location.city\"},\n        {source=\"src_region\", target=\"src_endpoint.location.region\"},\n        {source=\"src_time\", target=\"unmapped.src_time\"},\n        {source=\"src_timezone\", target=\"unmapped.src_timezone\"},\n        {source=\"src_zipcode\", target=\"src_endpoint.location.postal_code\"},\n        {source=\"srcip\", target=\"src_endpoint.ip\"},\n        {source=\"telemetry_app\", target=\"actor.invoked_by\"},\n        {source=\"timestamp\", target=\"metadata.original_time\"},\n        {source=\"title\", target=\"unmapped.title\"},\n        {source=\"traffic_type\", target=\"unmapped.traffic_type\"},\n        {source=\"transaction_id\", target=\"unmapped.transaction_id\"},\n        {source=\"type\", target=\"unmapped.type\"},\n        {source=\"ur_normalized\", target=\"actor.user.email_addr\"},\n        {source=\"url\", target=\"web_resource.url_string\"},\n        {source=\"user\", target=\"actor.user.email_addr\"},\n        {source=\"useragent\", target=\"unmapped.useragent\"},\n        {source=\"userip\", target=\"unmapped.userip\"},\n        {source=\"userkey\", target=\"unmapped.userkey\"},\n        {source=\"web_universal_connector\", target=\"unmapped.web_universal_connector\"},\n        {source=\"metadata.product.name\", target=\"metadata.product.name\"},\n        {source=\"metadata.product.vendor_name\", target=\"metadata.product.vendor_name\"},\n        {source=\"metadata.version\", target=\"metadata.version\"},\n        {source=\"dataSource.category\", target=\"dataSource.category\"},\n        {source=\"dataSource.name\", target=\"dataSource.name\"},\n        {source=\"dataSource.vendor\", target=\"dataSource.vendor\"},\n        {source=\"class_uid\", target=\"class_uid\"},\n        {source=\"class_name\", target=\"class_name\"},\n        {source=\"category_uid\", target=\"category_uid\"},\n        {source=\"category_name\", target=\"category_name\"},\n        {source=\"type_uid\", target=\"type_uid\"},\n        {source=\"type_name\", target=\"type_name\"},\n        {source=\"dst_endpoint.location.coordinates\", target=\"dst_endpoint.location.coordinates\"},\n        {source=\"src_endpoint.location.coordinates\", target=\"src_endpoint.location.coordinates\"},\n        {source=\"activity_name\", target=\"activity_name\"},\n        {source=\"activity_id\", target=\"activity_id\"},\n        {source=\"severity_id\", target=\"severity_id\"},\n        {source=\"message\", target=\"message\"},\n    }\n    for _, mapping in ipairs(fieldMappings) do\n        copyField(event, result, mapping.source, mapping.target)\n    end\n\n    result = copyUnmappedFields(event, fieldMappings, result)\n    return result\nend\n\nfunction getSecurityAssessmentEvents(event)\n    local result = getDefaultMapping(event)\n    result[\"class_uid\"] = 2001\n    result[\"class_name\"] = \"Security Finding\"\n    result[\"category_uid\"] = 2\n    result[\"category_name\"] = \"Findings\"\n    result[\"type_uid\"] = 200199\n    result[\"type_name\"] = \"Security Finding: Other\"\n    result[\"resources\"] = {\n        {owner = {account = {uid = getValue(event, \"account_id\", nil)}}},\n        {\n            data = {\n                asset_id = getValue(event, \"asset_id\", nil),\n                asset_object_id = getValue(event, \"asset_object_id\", nil),\n                category = getValue(event, \"category\", nil),\n                iaas_asset_tags = getValue(event, \"iaas_asset_tags\", nil),\n                iaas_remediated = getValue(event, \"iaas_remediated\", nil),\n                instance_id = getValue(event, \"instance_id\", nil),\n                object = getValue(event, \"object\", nil),\n                object_type = getValue(event, \"object_type\", nil),\n                region_id = getValue(event, \"region_id\", nil),\n                region_name = getValue(event, \"region_name\", nil),\n                resource_category = getValue(event, \"resource_category\", nil),\n                resource_group = getValue(event, \"resource_group\", nil),\n            }\n        },\n    }\n    local fieldMappings = {\n            {source=\"_category_id\", target=\"unmapped._category_id\"},\n            {source=\"_correlation_id\", target=\"metadata.correlation_uid\"},\n            {source=\"_ef_received_at\", target=\"unmapped._ef_received_at\"},\n            {source=\"_event_id\", target=\"unmapped._event_id\"},\n            {source=\"_forwarded_by\", target=\"unmapped._forwarded_by\"},\n            {source=\"_gef_src_dp\", target=\"unmapped._gef_src_dp\"},\n            {source=\"_id\", target=\"unmapped._id\"},\n            {source=\"_insertion_epoch_timestamp\", target=\"unmapped._insertion_epoch_timestamp\"},\n            {source=\"_raw_event_inserted_at\", target=\"unmapped._raw_event_inserted_at\"},\n            {source=\"_service_identifier\", target=\"unmapped._service_identifier\"},\n            {source=\"_session_begin\", target=\"unmapped._session_begin\"},\n            {source=\"access_method\", target=\"unmapped.access_method\"},\n            {source=\"account_name\", target=\"unmapped.account_name\"},\n            {source=\"acked\", target=\"unmapped.acked\"},\n            {source=\"action\", target=\"unmapped.action\"},\n            {source=\"activity\", target=\"unmapped.activity\"},\n            {source=\"alert\", target=\"unmapped.alert\"},\n            {source=\"alert_name\", target=\"malware.name\"},\n            {source=\"alert_type\", target=\"finding.type\"},\n            {source=\"app\", target=\"unmapped.app\"},\n            {source=\"appcategory\", target=\"unmapped.appcategory\"},\n            {source=\"browser\", target=\"unmapped.browser\"},\n            {source=\"cci\", target=\"unmapped.cci\"},\n            {source=\"ccl\", target=\"unmapped.ccl\"},\n            {source=\"compliance_standards\", target=\"unmapped.compliance_standards\"},\n            {source=\"count\", target=\"count\"},\n            {source=\"device\", target=\"unmapped.device\"},\n            {source=\"organization_unit\", target=\"unmapped.organization_unit\"},\n            {source=\"os\", target=\"unmapped.os\"},\n            {source=\"other_categories\", target=\"unmapped.other_categories\"},\n            {source=\"policy\", target=\"unmapped.policy\"},\n            {source=\"policy_id\", target=\"unmapped.policy_id\"},\n            {source=\"sa_profile_id\", target=\"unmapped.sa_profile_id\"},\n            {source=\"sa_profile_name\", target=\"unmapped.sa_profile_name\"},\n            {source=\"sa_rule_id\", target=\"unmapped.sa_rule_id\"},\n            {source=\"sa_rule_name\", target=\"unmapped.sa_rule_name\"},\n            {source=\"sa_rule_severity\", target=\"unmapped.sa_rule_severity\"},\n            {source=\"site\", target=\"unmapped.site\"},\n            {source=\"timestamp\", target=\"unmapped.timestamp\"},\n            {source=\"traffic_type\", target=\"unmapped.traffic_type\"},\n            {source=\"type\", target=\"unmapped.type\"},\n            {source=\"ur_normalized\", target=\"unmapped.ur_normalized\"},\n            {source=\"user\", target=\"unmapped.user\"},\n            {source=\"userkey\", target=\"unmapped.userkey\"},\n            {source=\"metadata.product.name\", target=\"metadata.product.name\"},\n            {source=\"metadata.product.vendor_name\", target=\"metadata.product.vendor_name\"},\n            {source=\"metadata.version\", target=\"metadata.version\"},\n            {source=\"dataSource.category\", target=\"dataSource.category\"},\n            {source=\"dataSource.name\", target=\"dataSource.name\"},\n            {source=\"dataSource.vendor\", target=\"dataSource.vendor\"},\n            {source=\"class_uid\", target=\"class_uid\"},\n            {source=\"class_name\", target=\"class_name\"},\n            {source=\"category_uid\", target=\"category_uid\"},\n            {source=\"category_name\", target=\"category_name\"},\n            {source=\"type_uid\", target=\"type_uid\"},\n            {source=\"type_name\", target=\"type_name\"},\n            {source=\"activity_name\", target=\"activity_name\"},\n            {source=\"activity_id\", target=\"activity_id\"},\n            {source=\"severity_id\", target=\"severity_id\"},\n            {source=\"message\", target=\"message\"},\n            {source=\"resources\", target=\"resources\"},\n    }\n    for _, mapping in ipairs(fieldMappings) do\n        copyField(event, result, mapping.source, mapping.target)\n    end\n\n    result = copyUnmappedFields(event, fieldMappings, result)\n    return result\nend\n\nfunction getBaseEventMapping(event)\n    local baseEventMapping = {}\n    local skippableFields = {\n        class_uid = true,\n        class_name = true,\n        category_uid = true,\n        category_name = true,\n        activity_id = true,\n        activity_name = true,\n        type_uid = true,\n        type_name = true,\n        metadata = true,\n        dataSource = true,\n        event = true,\n    }\n    for field_name, field_value in pairs(event) do\n        local field_name_str = tostring(field_name)\n        if not skippableFields[field_name_str] and field_name_str ~= \"_ob\" and field_value ~= nil and field_value ~= \"\" then\n            baseEventMapping[field_name_str] = \"unmapped.\" .. field_name_str\n        end\n    end\n\n    local specificMappings = {\n        [\"metadata.product.name\"] = \"metadata.product.name\",\n        [\"metadata.product.vendor_name\"] = \"metadata.product.vendor_name\",\n        [\"metadata.version\"] = \"metadata.version\",\n        [\"dataSource.category\"] = \"dataSource.category\",\n        [\"dataSource.name\"] = \"dataSource.name\",\n        [\"dataSource.vendor\"] = \"dataSource.vendor\",\n        [\"class_uid\"] = \"class_uid\",\n        [\"class_name\"] = \"class_name\",\n        [\"category_uid\"] = \"category_uid\",\n        [\"category_name\"] = \"category_name\",\n        [\"type_uid\"] = \"type_uid\",\n        [\"type_name\"] = \"type_name\",\n        [\"activity_name\"] = \"activity_name\",\n        [\"activity_id\"] = \"activity_id\",\n        [\"severity_id\"] = \"severity_id\",\n        [\"message\"] = \"message\",\n    }\n\n    -- Merge the specific mappings into the base map (equivalent to Python's update).\n    for key, value in pairs(specificMappings) do\n        baseEventMapping[key] = value\n    end\n\n    return baseEventMapping\nend\n\nfunction getQuarantineEvents(event)\n    local result = {}\n    alertType = getValue(event, \"alert_type\", \"Other\")\n    result[\"class_uid\"] = 0\n    result[\"class_name\"] = \"Base Event\"\n    result[\"category_uid\"] = 0\n    result[\"category_name\"] = \"Uncategorized\"\n    result[\"activity_id\"] = 99\n    result[\"activity_name\"] = alertType\n    result[\"type_uid\"] = 99\n    result[\"type_name\"] = \"Base Event: Other\"\n    result[\"metadata\"] = {product = {name = \"Netskope\", vendor_name = \"Netskope\"}, version = \"1.0.0\"}\n    result[\"dataSource\"] = {category = \"security\", name = \"Netskope\", vendor = \"Netskope\"}\n    result[\"event\"] = {type = alertType}\n\n    fieldMappings = getBaseEventMapping(event)\n    for source, target in pairs(fieldMappings) do\n        copyField(event, result, source, target)\n    end\n    return result\nend\n\nfunction processSecurityFinding(event)\n    local result = {}\n    local field_order = {}\n    if string.lower(getValue(event, \"alert_type\", \"\")) == string.lower(\"DLP\") then\n        result = getDlpEvents(event)\n        field_order = DLP_FIELD_ORDERS\n    elseif string.lower(getValue(event, \"alert_type\", \"\")) == string.lower(\"Uba\") then\n        result = getUbaEvents(event)\n        field_order = UBA_FIELD_ORDERS\n    elseif string.find(string.lower(getValue(event, \"alert_type\", \"\")), \"compromised\") and string.find(string.lower(getValue(event, \"alert_type\", \"\")), \"credential\") then\n        result = getCompromisedCredentialEvents(event)\n        field_order = COMPROMISED_CREDENTIAL_FIELD_ORDERS\n    elseif string.lower(getValue(event, \"alert_type\", \"\")) == string.lower(\"Malsite\") then\n        result = getMalsiteEvents(event)\n        field_order = MALSITE_FIELD_ORDERS\n    elseif string.lower(getValue(event, \"alert_type\", \"\")) == string.lower(\"Malware\") then\n        result = getMalwareEvents(event)\n        field_order = MALWARE_FIELD_ORDERS\n    elseif string.lower(getValue(event, \"alert_type\", \"\")) == string.lower(\"Policy\") then\n        event[\"alert_type\"] = \"Policy\"\n        result = getPolicyEvents(event)\n        field_order = POLICY_FIELD_ORDERS\n    elseif string.lower(getValue(event, \"alert_type\", \"\")) == string.lower(\"quarantine\") then\n        result = getQuarantineEvents(event)\n        field_order = QUARANTINE_FIELD_ORDERS\n    elseif string.find(string.lower(getValue(event, \"alert_type\", \"\")), \"security\") and string.find(string.lower(getValue(event, \"alert_type\", \"\")), \"assessment\") then\n        result = getSecurityAssessmentEvents(event)\n        field_order = SECURITY_ASSESSMENT_FIELD_ORDERS\n    else\n        -- If nothing matches we send back the input event\n        result = event\n    end\n    -- preserve the original event in the message field\n    -- Create message field with original event\n    local cleanEvent = {}\n    for key, value in pairs(event) do\n        if key ~= \"_ob\" then\n            cleanEvent[key] = value\n        end\n    end\n    result.message = encodeJson(cleanEvent, \"root\", field_order)\n\n    -- add ocsf time fields\n    -- convert to millis\n    result[\"time\"] = event[\"timestamp\"]*1000 \n\n    if FEATURES.FLATTEN_EVENT_TYPE then\n        if result and result.event then\n            result['event.type'] = result.event.type\n        end\n    end\n    return result\nend\n\n-- Main event processing function\nfunction processEvent(event)\n    if event == nil then\n        return {}\n    end\n    return processSecurityFinding(event)\nend\n",
                        "serializer": "netskope-lua"
                    }
                ]
            },
            "status": "NS_ACTIVE",
            "created": "2025-11-19T22:40:40.161971Z",
            "updated": "2025-11-19T22:40:40.161971Z",
            "createdBy": "",
            "updatedBy": "",
            "isTransformGroup": false,
            "origin": "NODE_ORIGIN_USER",
            "templateName": "OCSFSerializer",
            "processorType": "DATA_PROCESSOR",
            "siteFilenames": [],
            "userVisible": true
        }
    ],
    "archivalDestination": null
}
